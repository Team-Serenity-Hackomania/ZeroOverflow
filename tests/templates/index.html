<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Waste Dashboard</title>
<style>
  :root {
    /* Eco & Poppy Theme Palette */
    --bg: #f8f9fa; /* Light, clean background (off-white) */
    --card: #ffffff; /* Clean white cards */
    --text: #333; /* Dark grey text, not pure black */
    --muted: #6c757d; /* Muted grey */
    --accent: #28a745; /* Vibrant Eco Green */
    --ok: #4caf50; /* Status: Good (darker text shade) */
    --warn: #f57c00; /* Status: Warning (darker text shade) */
    --alert: #d32f2f; /* Status: Alert (darker text shade) */
    --ok-bg: #e8f5e9; /* Light green background */
    --warn-bg: #fff3e0; /* Light orange background */
    --alert-bg: #ffebee; /* Light red background */
    --border-light: #e0e0e0; /* Light border color */
    --shadow: rgba(0, 0, 0, 0.05); /* Soft shadow */
    
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
  }
  
  .wrap { max-width: 1100px; margin: 36px auto; padding: 20px; }
  
  header {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 18px;
  }
  
  h1 { font-size: 1.5rem; margin: 0; color: #222; }
  
  .controls { display: flex; gap: 8px; align-items: center; }
  
  .btn {
    background: var(--accent);
    border: 1px solid var(--accent);
    color: #ffffff;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .btn:hover {
    background: #218838;
    border-color: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  .search {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
    background: var(--card);
    color: var(--text);
    transition: border 0.2s ease, box-shadow 0.2s ease;
  }
  .search:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  }
  
  .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media(min-width: 900px) { .grid { grid-template-columns: 1fr 320px; } }
  
  .table-card, .card {
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 4px 12px var(--shadow);
    border: 1px solid #f0f0f0;
  }
  
  .right-col { display: grid; gap: 12px; align-content: start; }
  
  table {
    width: 100%;
    border-collapse: collapse;
    color: var(--text);
    font-size: 0.95rem;
  }
  th, td {
    padding: 12px 10px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
  }
  th {
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
  }
  tbody tr {
    transition: background-color 0.2s ease;
  }
  tbody tr:hover {
    background-color: #f7fcf7; /* Light green hover */
  }
  
  .pill {
    display: inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 0.8rem;
    line-height: 1;
  }
  .ok { background: var(--ok-bg); color: var(--ok); }
  .warn { background: var(--warn-bg); color: var(--warn); }
  .alert { background: var(--alert-bg); color: var(--alert); }
  
  .meta { color: var(--muted); font-size: 0.85rem; margin-top: 6px; }
  
  .stat {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent); /* Green stat! */
    margin: 4px 0;
  }
  .tiny {
    font-size: 0.8rem;
    color: var(--muted);
    text-transform: uppercase;
    font-weight: 600;
  }
  
  .loading {
    display: inline-block;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 3px solid #e0e0e0;
    border-top-color: var(--accent); /* Green spinner */
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .empty { padding: 28px; text-align: center; color: var(--muted); }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>‚ôªÔ∏è Smart Waste Dashboard</h1>
        <div class="meta small">Live view of bins, fill percentage, battery & last update</div>
      </div>
      <div class="controls">
        <input id="q" class="search" placeholder="Search by Bin ID or location..." />
        <button id="refresh" class="btn">Refresh</button>
        <div id="spinner" style="display:none" title="loading" class="loading" aria-hidden="true"></div>
      </div>
    </header>

    <div class="grid">
      <div class="table-card">
        <table id="bins-table" aria-live="polite">
          <thead>
            <tr>
              <th>Bin ID</th>
              <th>üìç Location</th>
              <th>Fill</th>
              <th>Capacity(L)</th>
              <th>üîã Battery</th>
              <th>Last Updated</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="6" class="empty">Loading data‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div classs="right-col">
        <div class="card">
          <div class="tiny">Total bins</div>
          <div id="total" class="stat">‚Äî</div>
          <div class="tiny meta">Bins above threshold: <span id="above" style="font-weight:700; color: var(--alert);">0</span></div>
        </div>
        <div class="card">
          <div class="tiny">Latest update</div>
          <div id="latest" class="small">‚Äî</div>
          <div class="meta">Click a row to copy Bin ID</div>
        </div>
      </div>
    </div>
  </div>

<script>
const API_URL = "{{ proxy_url }}"; /* injected by Flask/Jinja */
const body = document.getElementById('table-body');
const totalEl = document.getElementById('total');
const aboveEl = document.getElementById('above');
const latestEl = document.getElementById('latest');
const q = document.getElementById('q');
const refreshBtn = document.getElementById('refresh');
const spinner = document.getElementById('spinner');

let binsCache = [];

function showSpinner(on){ spinner.style.display = on ? 'inline-block' : 'none'; }

function parseResponsePayload(json){
  if (!json) return [];
  if (Array.isArray(json)) return json;
  if (Array.isArray(json.bins)) return json.bins;
  if (json.error) {
    body.innerHTML = `<tr><td colspan="6" class="empty">Server error: ${escapeHtml(String(json.message || json.preview || json.error))}</td></tr>`;
    return [];
  }
  return [];
}

function fmtDate(ts){
  if (!ts) return '‚Äî';
  const d = new Date(ts);
  if (isNaN(d)) return ts;
  return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
}

function renderRows(list){
  if (!list.length){
    body.innerHTML = '<tr><td colspan="6" class="empty">No bins found.</td></tr>';
    totalEl.textContent = '0'; aboveEl.textContent = '0'; latestEl.textContent = '‚Äî'; return;
  }
  const rows = []; let latestTime = null; let aboveCount = 0;
  list.forEach(b=>{
    const fp = Number(b.fill_percentage ?? 0);
    const thr = Number(b.threshold ?? 0);
    const statusClass = fp >= thr ? 'alert' : fp >= (thr*0.8) ? 'warn' : 'ok';
    if (fp >= thr) aboveCount++;
    const updated = b.last_updated ?? b.updated ?? null;
    if (updated) { const d = new Date(updated); if (!isNaN(d) && (!latestTime || d > latestTime)) latestTime = d; }
    rows.push(
      `<tr class="row-hover" data-bin="${escapeHtml(String(b.bin_id ?? ''))}">
        <td><strong>${escapeHtml(String(b.bin_id ?? '‚Äî'))}</strong></td>
        <td>${escapeHtml(String(b.location_name ?? '‚Äî'))}</td>
        <td><span class="pill ${statusClass}">${isNaN(fp) ? '‚Äî' : fp + '%'}</span></td>
        <td>${escapeHtml(String(b.capacity_liters ?? '‚Äî'))}</td>
        <td class="small">${escapeHtml(String(b.battery_level ?? '‚Äî'))} / ${escapeHtml(String(b.wifi_signal ?? '‚Äî'))}</td>
        <td>${escapeHtml(fmtDate(updated))}</td>
      </tr>`);
  });
  body.innerHTML = rows.join('');
  totalEl.textContent = String(list.length);
  aboveEl.textContent = String(aboveCount);
  latestEl.textContent = latestTime ? new Intl.DateTimeFormat(undefined,{dateStyle:'medium',timeStyle:'short'}).format(latestTime) : '‚Äî';

  document.querySelectorAll('[data-bin]').forEach(el=>{
    // UPDATED this line to use the new green accent color for the click highlight
    el.onclick = ()=> { navigator.clipboard?.writeText(el.getAttribute('data-bin')); el.style.outline='2px solid rgba(40,167,69,0.3)'; setTimeout(()=>el.style.outline='',400); };
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function fetchBins(){
  showSpinner(true);
  try {
    const res = await fetch(API_URL, {cache:'no-store', headers:{'Accept':'application/json'}});
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const json = await res.json();
    binsCache = parseResponsePayload(json);
    applyFilter();
  } catch (err){
    body.innerHTML = `<tr><td colspan="6" class="empty">Error fetching data: ${escapeHtml(err.message)}</td></tr>`;
    totalEl.textContent = '‚Äî'; aboveEl.textContent = '‚Äî'; latestEl.textContent = '‚Äî';
  } finally { showSpinner(false); }
}

function applyFilter(){
  const term = q.value.trim().toLowerCase();
  let list = binsCache.slice();
  if (term) list = list.filter(b => (String(b.bin_id||'') + ' ' + String(b.location_name||'')).toLowerCase().includes(term));
  renderRows(list);
}

q.addEventListener('input', applyFilter);
refreshBtn.addEventListener('click', fetchBins);

fetchBins();
setInterval(fetchBins, 10000);
</script>
</body>
</html>